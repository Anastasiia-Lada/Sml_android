<!DOCTYPE HTML>
<html>
<head>    
    <title>S360</title>
    <style type="text/css">
        /**
         * Example of an initial loading indicator.
         * It is recommended to keep this as minimal as possible to provide instant feedback
         * while other resources are still being loaded for the first time
         */
        html, body {
            background: url("resources/images/loadingimage-r2.png") no-repeat center center;
            background-size: cover;
        }

        #appLoadingIndicator {
            position: absolute;
            top: 100%;
            margin-top: -15px;
            text-align: center;
            width: 100%;
            height: 30px;
            -webkit-animation-name: appLoadingIndicator;
            -webkit-animation-duration: 5s;
            -webkit-animation-iteration-count: infinite;
            -webkit-animation-direction: linear;
        }

            #appLoadingIndicator > * {
                background-color: #e19b20;
                display: inline-block;
                height: 10px;
                width: 100%;
            }

        @-webkit-keyframes appLoadingIndicator {
            from {
                width: 0%;
            }

            25% {
                width: 25%;
            }

            50% {
                width: 50%;
            }

            75% {
                width: 75%;
            }

            to {
                width: 100%;
            }
        }
    </style>
    <!-- The line below must be kept intact for Sencha Command to build your application -->
    <script src="jquery-2.0.3.js"></script>
    <script src="phonegap.js"></script>
    <script src="splashscreen.js"></script>   
    <script type="text/javascript" src="plupload.full.min.js"></script>
    <script src="cordova.js"></script>
    <!-- cordova facebook plugin -->
    <script src="cdv-plugin-fb-connect.js"></script>
    <!-- facebook js sdk -->
    <script src="facebook-js-sdk.js"></script>
    <!--<script src="src/canvas-to-blob.min.js"></script>-->
    <script id="microloader" type="text/javascript" src="touch/microloader/development.js"></script>



</head>
<body style="background-color: #1f88c0">
        
        <div id="data"></div>
        <!--<script src="http://localhost:8080/target/target-script-min.js#anonymous"></script>-->
        <div id="fb-root"></div>
               
        <script>
            
             <!-- These are the notifications that are displayed to the user through pop-ups if the above JS files does not exist in the same directory-->

    var tmp_params = {
    facebookID: '',
    guid: '',
    fbtoken: '',
    };
    var saved_controller_obj = {};

    //if ((typeof cordova == 'undefined') && (typeof Cordova == 'undefined')) alert('Cordova variable does not exist. Check that you have included cordova.js correctly');
    //if (typeof CDV == 'undefined') alert('CDV variable does not exist. Check that you have included cdv-plugin-fb-connect.js correctly');
    //if (typeof FB == 'undefined') alert('FB variable does not exist. Check that you have included the Facebook JS SDK file.');

    FB.Event.subscribe('auth.login', function (response) {
        alert('FB login');

    });

    FB.Event.subscribe('auth.logout', function (response) {
    });

    FB.Event.subscribe('auth.sessionChange', function (response) {
       
    });

    FB.Event.subscribe('auth.statusChange', function (response) {
    });

    FB.Event.subscribe('auth.authResponseChange',
        function (response) {
        });

    var permissions = 'email, user_birthday, read_stream';

    function fb_login() {
        FB.getLoginStatus(updateStatusCallback, true);
    }

    function updateStatusCallback(response) {
        if (response.status === 'connected') {
            login(permissions);
        }
        else if (response.status === 'not_authorized') {
            login(permissions);
        } else {
            login(permissions);
        }
    }

    function login(sc) {
        
                        FB.login(function (response) {
                            if (response.authResponse) { 
                                loginToServer();
                            }
                            else {
                                FB.api('/me/permissions', 'DELETE',
                                            function(response) {
                                              FB.logout(function(response){
                                                alert('user logged out on error');
                                                window.location.reload();
                                            });
                                          });
                            }
                        }, { scope: sc });
    }

    function revoke() {
        FB.init({
            appId: "213563938819286",
            nativeInterface: CDV.FB,
            useCachedDialogs: false,
            status: true,           // Check Facebook Login status
            cookie: true,           // enable cookies to allow the server to access the session
            oauth: true,            // enable OAuth 2.0
            xfbml: false,
        });
    }

    function loginToServer() {

        FB.api('me?fields=email', function (response) {
            
            tmp_params = {
                                        facebookID: response.id,
                                        guid: 'isSet',
                                        fbtoken: FB.getAccessToken(),
                                    };
                                    alert('params'+ JSON.stringify(tmp_params));
            Ext.getStore('membersStore').load(function () {
                                    alert('store onload alert');
                                    var membersStore = smiley360.services.getMemberStore();
                                    if( (tmp_params.guid == 'isSet')&& (membersStore.getCount() > 0) )                              
                                        {
                                            tmp_params.guid = smiley360.services.getDeviceId();
                                            alert('set from deviceid'+tmp_params.guid);
                                        };  
                                    saved_controller_obj.loadProfileDropdowns(function () {
                                        if (tmp_params.facebookID != '') {
                                            //alert('find fbId'+tmp_params.facebookID);
                                            smiley360.services.loginToServer(tmp_params, function (fb_session) {
                                                alert('doneLoginToserver');   
                                                //alert(JSON.stringify(tmp_params));    
                                                //alert(JSON.stringify(fb_session));                                        
                                                saved_controller_obj.tryLoginUser();
                                            });
                                        }
                                            //alert('tmp_params.facebookID' + tmp_params.facebookID);
                                        else saved_controller_obj.tryLoginUser();

                                    });
                                });
        });

    
    }

    function find_member() {
        alert('find member');
        saved_controller_obj.tryLoginUser();
    }

    document.addEventListener('deviceready', function () {
        FB.init({
            appId: "213563938819286",
            nativeInterface: CDV.FB,
            useCachedDialogs: false,
            status: false,           // Check Facebook Login status
            cookie: true,           // enable cookies to allow the server to access the session
            oauth: true,            // enable OAuth 2.0
            xfbml: false,
        });
        document.getElementById('data').innerHTML = "";
        navigator.splashscreen.hide();
        //Ext.Msg.alert('deviceready');
    }, false);
            </script>
        <div id="log"></div>

    <div id="appLoadingIndicator">
        <div></div>
    </div>
</body>
</html>
